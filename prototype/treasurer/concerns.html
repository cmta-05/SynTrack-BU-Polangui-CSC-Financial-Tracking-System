<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Concerns - CSC Financial (Concerns / Dispute)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Shared app styles for consistent look with login/dashboard -->
  <link rel="stylesheet" href="../assets/css/style.css" />
  <style>
    /* Page-specific light helpers */
    body:not(.theme-dark) { background:#f7f9fc; }
    .main-content { max-width:1280px; margin:auto; }
    .status-badge { min-width:110px; display:inline-block; text-align:center; }
    .file-preview { max-height:80px; object-fit:cover; margin-right:8px; border-radius:4px; }
    .small-muted { font-size:0.85rem; color:#6c757d; }
    .audit-line { font-size:0.9rem; color:#444; padding:6px 0; border-bottom:1px dashed #e9ecef; }
    .required { color:#d00; }
    /* Tighten topbar to match treasurer dashboard */
    .topbar { padding: 0.75rem 1.25rem; }
    .topbar .topbar-title { font-size: 1rem; margin-bottom: 2px; }
    /* Notification dropdown matches treasurer dashboard (no header shift) */
    .notification-menu { position: relative; display: inline-block; }
    .notification-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      width: 360px;
      max-height: 500px;
      display: none;
      flex-direction: column;
      z-index: 2000;
    }
    .notification-dropdown.show { display: flex; }
    .notification-header,
    .notification-footer { padding: 0.75rem 1rem; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
    .notification-footer { border-bottom: 0; border-top: 1px solid #dee2e6; }
    .notification-list { flex: 1; overflow-y: auto; }
    .notification-item { padding: 0.75rem 1rem; border-bottom: 1px solid #e9ecef; display: flex; gap: 0.75rem; cursor: pointer; }
    .notification-item.unread { background-color: #e7f3ff; }
    .notification-icon { font-size: 1.25rem; flex-shrink: 0; }
    .badge-notification {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 0.65rem;
      padding: 0.22rem 0.36rem;
      border-radius: 999px;
      background-color: #dc3545;
      color: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      line-height: 1;
      z-index: 2000;
    }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- Sidebar -->
  <aside class="sidebar" id="appSidebar" aria-label="Sidebar">
    <div class="sidebar-brand">
      <div class="sidebar-logo-wrapper">
        <img src="../assets/img/csc-paytrack-logo.png" alt="SynTrack" class="sidebar-logo" />
      </div>
      <div class="sidebar-brand-text">
        <div class="fw-bold" style="font-size: 1.5rem;">SynTrack</div>
        <small>CSC Treasurer Portal</small>
      </div>
      <button
        class="btn btn-sm sidebar-collapse"
        type="button"
        onclick="toggleSidebar()"
      >
        â˜°
      </button>
    </div>
    <div class="sidebar-label">Main Menu</div>
    <nav>
      <a class="nav-link" href="treasurer_dashboard.html">
        <span>Dashboard</span>
      </a>
      <a class="nav-link" href="csc_fee.html">
        <span>CSC Fee</span>
      </a>
      <a class="nav-link active" href="concerns.html">
        <span>Concerns</span>
      </a>
      <a class="nav-link" href="treasurer_reports.html">
        <span>Reports</span>
      </a>
    </nav>
    <div class="sidebar-label-text">
      Bicol University Polangui<br>
      College Student Council<br>
      Financial Tracking System
    </div>
  </aside>

  <!-- Workspace -->
  <div class="workspace">
        <header class="topbar">
      <div class="topbar-left">
        <i class="bi bi-calendar3 topbar-date-icon"></i>
        <small id="currentDateTime" class="text-muted"></small>
      </div>
      <div class="topbar-actions">
        <button type="button" class="icon-btn theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle dark mode">ðŸŒ“</button>
        <button type="button" class="icon-btn notification-btn" aria-label="Notifications" onclick="toggleNotifications()">
          <span class="notification-badge">3</span>
          ðŸ””
        </button>
        <div class="user-menu">
          <div class="user-avatar" onclick="toggleUserMenu()" role="button">
            <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
          </div>
          <div id="userDropdown" class="user-dropdown">
            <div class="user-dropdown-header">
              <strong>BU Polangui CSC</strong>
              <div class="small text-muted">Treasurer</div>
            </div>
            <a href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Profile</a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#managePasswordModal">Manage Password</a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#contactAdminModal">Contact Admin</a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#feedbackModal">Send Feedback</a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#aboutDevelopersModal">About Developers</a>
            <a href="../login.html" class="sign-out">Sign Out</a>
          </div>
          <div id="notificationPanel" class="notification-panel">
            <div class="notification-item unread">
              <strong>Payment Pending Verification</strong>
              <p>Several CSC fee payments are waiting for review.</p>
              <small>Just now</small>
            </div>
            <div class="notification-item unread">
              <strong>New Concern Submitted</strong>
              <p>A student reported a CSC fee posting issue.</p>
              <small>1 hour ago</small>
            </div>
            <div class="notification-item">
              <strong>Daily Summary</strong>
              <p>View today's verified CSC fee payments in the Reports page.</p>
              <small>Today</small>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="page-content">
      <section class="dashboard-hero mb-4">
        <div class="row align-items-center">
          <div class="col-md-12">
            <h2 class="mb-1">CSC Fee Concerns Management</h2>
            <p class="hero-subtitle mb-0">Review, triage, and resolve CSC fee-related concerns efficiently.</p>
          </div>
        </div>
      </section>

      <main class="main-content pb-4">
        <div class="row g-4">

          <!-- Left: Student Concern Form (hidden by default, kept for reference/demo input) -->
          <section id="studentSection" class="col-lg-4 d-none">
            <div class="card shadow-sm">
              <div class="card-header">
                <strong>Submit a Concern / Dispute</strong>
                <div class="small-muted">Follow the form carefully â€” attach at least one proof.</div>
              </div>
              <div class="card-body">
                <form id="concernForm" novalidate>
                  <!-- Auto-fill student info (placeholder for integration with auth) -->
                  <div class="mb-2">
                    <label class="form-label">Student ID <span class="required">*</span></label>
                    <input id="studentId" class="form-control" placeholder="e.g. 2021-00001" required />
                    <div class="form-text small-muted">Will be auto-filled when student is logged in (for demo, edit manually).</div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Student Name <span class="required">*</span></label>
                    <input id="studentName" class="form-control" placeholder="Juan Dela Cruz" required />
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Module / Type <span class="required">*</span></label>
                    <select id="moduleSelect" class="form-select" required>
                      <option value="">-- Select Module --</option>
                      <option>CSC Fee</option>
                      <option>Merchandise</option>
                      <option>PE Uniform</option>
                      <option>Seal & Plate</option>
                      <option>ID Lace</option>
                      <option>Other</option>
                    </select>
                  </div>

                  <div class="row g-2">
                    <div class="col-6 mb-2">
                      <label class="form-label">Payment Date <span class="required">*</span></label>
                      <input id="paymentDate" type="date" class="form-control" required />
                    </div>
                    <div class="col-6 mb-2">
                      <label class="form-label">Amount (PHP) <span class="required">*</span></label>
                      <input id="amount" type="number" step="0.01" min="0" class="form-control" placeholder="e.g. 150.00" required />
                    </div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Reference / Receipt No. <span class="required">*</span></label>
                    <input id="reference" class="form-control" placeholder="Receipt # or Reference ID" required />
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Description of Issue <span class="required">*</span></label>
                    <textarea id="description" class="form-control" rows="4" placeholder="Explain what happened (e.g., paid but status shows pending)" required></textarea>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Attach Proof (images or PDF; max 3; max 5MB each) <span class="required">*</span></label>
                    <input id="proofFiles" type="file" class="form-control" accept=".png,.jpg,.jpeg,.pdf" multiple required />
                    <div id="previewArea" class="mt-2 d-flex"></div>
                    <div class="form-text small-muted">Helpful: upload the block treasurer receipt, screenshot of payment, or bank/payment slip.</div>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small-muted">By submitting, you confirm the information is accurate.</div>
                    <button type="button" id="submitConcernBtn" class="btn btn-primary">Submit Concern</button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Student's Submitted Concerns history -->
            <div class="card shadow-sm mt-3">
              <div class="card-header">
                <strong>Your Concerns</strong>
                <div class="small-muted">Track status below</div>
              </div>
              <div class="card-body" id="studentHistory">
                <p class="small-muted">No concerns submitted yet.</p>
              </div>
            </div>
          </section>

          <!-- Right: Treasurer Dashboard -->
          <section id="treasurerSection" class="col-lg-12">
            <div class="card shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <strong>CSC Fee Concerns Records</strong>
                  <div class="small-muted">Filter, review, and resolve concerns</div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                  <button type="button" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF (Mock)
                  </button>
                  <select id="filterStatus" class="form-select form-select-sm">
                    <option value="all">All statuses</option>
                    <option value="Pending Verification">Pending Verification</option>
                    <option value="Under Review">Under Review</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Rejected">Rejected</option>
                  </select>
                  <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
                </div>
              </div>

              <div class="card-body table-responsive">
                <table class="table table-sm table-hover align-middle">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Issue</th>
                      <th>Proof</th>
                      <th>Date</th>
                      <th>Other Details</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="treasurerTableBody">
                    <!-- rows rendered by JS -->
                  </tbody>
                </table>
                <div class="small-muted">Click action to open the review modal.</div>
              </div>
            </div>

            <!-- Audit trail -->
            <div class="card shadow-sm mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Audit Log</strong>
                <button type="button" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF (Mock)
                </button>
              </div>
              <div class="card-body" id="auditLog">
                <p class="small-muted">No actions yet.</p>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <footer class="app-footer">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
            <div class="d-flex align-items-center justify-content-center justify-content-md-start gap-2">
              <img src="../assets/img/csc-paytrack-logo.png" alt="SynTrack Logo" style="width: 32px; height: 32px; object-fit: contain;" />
              <span class="fw-semibold">SynTrack</span>
            </div>
          </div>
          <div class="col-md-6 text-center text-md-end">
            <div class="small">
              <div class="mb-1">Bicol University Polangui - College Student Council</div>
              <div class="text-muted">Financial Tracking and Payment Management System</div>
            </div>
          </div>
        </div>
        <div class="row mt-3 pt-3 border-top">
          <div class="col-12 text-center">
            <div class="mb-2">
              <a href="https://www.facebook.com/bupc.csc.one" target="_blank" rel="noopener noreferrer" class="facebook-link">
                <i class="bi bi-facebook me-2"></i>Bicol University Polangui College Student Council Facebook Page
              </a>
            </div>
            <small class="text-muted">Â© 2025 SynTrack. All rights reserved.</small>
          </div>
        </div>
      </div>
    </footer>
  </div>
</div>

<!-- Review / Resolve Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Review Concern <small id="modalConcernId" class="text-muted"></small></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent">
          <!-- Concern details inserted by JS -->
          <div class="mb-2"><strong>Student:</strong> <span id="modalStudent"></span></div>
          <div class="mb-2"><strong>Module:</strong> <span id="modalModule"></span></div>
          <div class="mb-2"><strong>Payment Date:</strong> <span id="modalPayDate"></span></div>
          <div class="mb-2"><strong>Amount:</strong> â‚±<span id="modalAmount"></span></div>
          <div class="mb-2"><strong>Reference:</strong> <span id="modalRef"></span></div>
          <div class="mb-2"><strong>Description:</strong><div class="mt-1 small-muted" id="modalDesc"></div></div>

          <div class="mb-3">
            <strong>Attachments:</strong>
            <div id="modalAttachments" class="d-flex flex-wrap mt-2"></div>
          </div>

          <hr />

          <div class="mb-2">
            <label class="form-label">Resolution Notes</label>
            <textarea id="resolutionNotes" class="form-control" rows="3" placeholder="Explain resolution or rejection reason"></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Upload supporting document (optional)</label>
            <input id="resolutionFile" type="file" class="form-control" accept=".png,.jpg,.jpeg,.pdf" />
          </div>

          <div class="mb-2 small-muted">
            When resolved, the system will record resolution, notify the student, and append to audit log.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnMarkReview" class="btn btn-warning">Mark Under Review</button>
        <button id="btnReject" class="btn btn-outline-danger">Reject</button>
        <button id="btnResolve" class="btn btn-success">Resolve</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
  <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../assets/js/data.js"></script>
<script src="../assets/js/forms.js"></script>
<script src="../assets/js/main.js"></script>
<script src="../assets/js/treasurer_data.js"></script>
<script>
  /*******************************************************
   * Demo client-side concerns prototype
   * - Use this as a UI that follows your RDR (FR-15, FR-16)
   * - Replace local JS storage with API calls to your backend.
   *******************************************************/

  // In-memory store for demo (replace with real API)
  const concernsStore = [];
  const auditStore = [];

  // Simple id generator
  const genId = ()=> 'C' + String(Date.now()).slice(-6);

  // Bootstrap components
  const reviewModalEl = document.getElementById('reviewModal');
  const reviewModal = new bootstrap.Modal(reviewModalEl);
  const toastEl = document.getElementById('liveToast');
  const toast = new bootstrap.Toast(toastEl);

  // Default view shows Treasurer dashboard; student form kept hidden for demo data entry if needed
  document.getElementById('studentSection').classList.add('d-none');
  renderTreasurerTable();

  // Initialize shared layout helpers
  applyStoredTheme && applyStoredTheme();
  startClock && startClock("currentDateTime");
  setupNotificationListeners && setupNotificationListeners();

  /* Notifications: update badge count based on unread items in the DOM */
  function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    const list = document.querySelectorAll('#notificationList .notification-item.unread');
    if (badge) badge.textContent = list.length;
  }

  /* Notification dropdown helpers */
  function toggleNotifications(event) {
    if (event) event.stopPropagation();
    const dropdown = document.getElementById('notificationDropdown');
    if (dropdown) dropdown.classList.toggle('show');
    updateNotificationBadge();
  }
  function closeNotifications(event) {
    if (event) event.stopPropagation();
    const dropdown = document.getElementById('notificationDropdown');
    if (dropdown) dropdown.classList.remove('show');
  }

  /* Close notifications when clicking outside */
  function setupNotificationListeners() {
    document.addEventListener('click', function(event) {
      const notificationMenu = document.querySelector('.notification-menu');
      const dropdown = document.getElementById('notificationDropdown');
      if (notificationMenu && dropdown && !notificationMenu.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
  }

  // Start with accurate badge count
  updateNotificationBadge();

  // File preview for student form
  document.getElementById('proofFiles').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files).slice(0,3);
    const previewArea = document.getElementById('previewArea');
    previewArea.innerHTML = '';
    files.forEach(file => {
      if(file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.className = 'file-preview';
        img.src = URL.createObjectURL(file);
        img.alt = file.name;
        previewArea.appendChild(img);
      } else {
        const box = document.createElement('div');
        box.className = 'border rounded p-2 me-2 small-muted';
        box.textContent = file.name;
        previewArea.appendChild(box);
      }
    });
  });

  // Submit concern (student)
  document.getElementById('submitConcernBtn').addEventListener('click', (e)=>{
    const form = document.getElementById('concernForm');
    // Basic validation
    const requiredFields = ['studentId','studentName','moduleSelect','paymentDate','amount','reference','description'];
    let ok = true;
    requiredFields.forEach(id=>{
      const el = document.getElementById(id);
      if(!el.value || el.value.trim()==='') { ok=false; el.classList.add('is-invalid'); setTimeout(()=>el.classList.remove('is-invalid'),1500); }
    });
    const files = document.getElementById('proofFiles').files;
    if(files.length === 0) { ok=false; document.getElementById('proofFiles').classList.add('is-invalid'); setTimeout(()=>document.getElementById('proofFiles').classList.remove('is-invalid'),1500); }
    if(!ok) return showToast('Please fill all required fields and attach proof.');

    // create concern object (in real app, POST to server with FormData including files)
    const concern = {
      id: genId(),
      createdAt: new Date().toISOString(),
      studentId: document.getElementById('studentId').value.trim(),
      studentName: document.getElementById('studentName').value.trim(),
      module: document.getElementById('moduleSelect').value,
      paymentDate: document.getElementById('paymentDate').value,
      amount: Number(document.getElementById('amount').value).toFixed(2),
      reference: document.getElementById('reference').value.trim(),
      description: document.getElementById('description').value.trim(),
      attachments: Array.from(files).map(f=>f.name), // demo: store names
      status: 'Pending Verification'
    };
    concernsStore.unshift(concern);
    auditStore.unshift({time:new Date().toISOString(), user:concern.studentName, action:'Submitted concern', concernId:concern.id});
    renderStudentHistory();
    showToast('Concern submitted. Treasurer will review within 5 working days.');
    // reset minimal fields
    document.getElementById('concernForm').reset();
    document.getElementById('previewArea').innerHTML = '';
    // If treasurer view open, refresh table
    renderTreasurerTable();
  });

  // Render student history
  function renderStudentHistory(){
    const container = document.getElementById('studentHistory');
    const sid = document.getElementById('studentId').value.trim();
    let entries = concernsStore;
    if(sid) entries = concernsStore.filter(c=>c.studentId === sid);
    if(entries.length === 0){
      container.innerHTML = '<p class="small-muted">No concerns submitted yet.</p>';
      return;
    }
    container.innerHTML = '';
    entries.slice(0,10).forEach(c=>{
      const card = document.createElement('div');
      card.className = 'mb-2 p-2 border rounded';
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div><strong>${c.module}</strong> â€¢ <small class="text-muted">${c.reference}</small></div>
            <div class="small-muted">${new Date(c.createdAt).toLocaleString()}</div>
            <div class="mt-1">${c.description}</div>
            <div class="mt-1 small-muted">Attachments: ${c.attachments.join(', ')}</div>
          </div>
          <div class="text-end">
            <div class="badge status-badge ${statusColor(c.status)}">${c.status}</div>
            <div class="small-muted mt-2">ID: ${c.id}</div>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // Treasurer: render table (CSC Fee Concerns Management layout)
  function renderTreasurerTable(){
    const tbody = document.getElementById('treasurerTableBody');
    tbody.innerHTML = '';
    const filter = document.getElementById('filterStatus').value;
    (concernsStore.filter(c => filter==='all' ? true : c.status === filter)).forEach(c=>{
      const tr = document.createElement('tr');
      const issueSummary = c.description.length > 80 ? c.description.substring(0,77) + '...' : c.description;
      const proofLabel = c.attachments && c.attachments.length ? c.attachments.join(', ') : 'Uploaded proof';
      tr.innerHTML = `
        <td>${escapeHtml(c.studentName)}<div class="small-muted">${c.studentId}</div></td>
        <td>${escapeHtml(issueSummary)}</td>
        <td class="small-muted">${escapeHtml(proofLabel)}</td>
        <td>${(new Date(c.createdAt)).toLocaleDateString()}</td>
        <td>
          <div class="small-muted">
            <div><strong>Module:</strong> ${c.module}</div>
            <div><strong>Amount:</strong> â‚±${c.amount}</div>
            <div><strong>Ref:</strong> ${escapeHtml(c.reference)}</div>
          </div>
        </td>
        <td><div class="badge status-badge ${statusColor(c.status)}">${c.status}</div></td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-success" data-id="${c.id}" onclick="resolveOrReject('${c.id}','Resolved')">Resolved</button>
            <button class="btn btn-outline-danger" data-id="${c.id}" onclick="resolveOrReject('${c.id}','Rejected')">Reject</button>
          </div>
        </td>
      `;
      tr.addEventListener('click', (evt) => {
        // avoid double-open when clicking buttons
        if (evt.target.tagName.toLowerCase() === 'button') return;
        openReviewById(c.id);
      });
      tbody.appendChild(tr);
    });
  }

  // Open review modal (treasurer)
  function openReview(e){
    const id = e.currentTarget.getAttribute('data-id');
    openReviewById(id);
  }

  function openReviewById(id){
    const c = concernsStore.find(x=>x.id===id);
    if(!c) return showToast('Concern not found.');
    document.getElementById('modalConcernId').textContent = c.id;
    document.getElementById('modalStudent').textContent = `${c.studentName} (${c.studentId})`;
    document.getElementById('modalModule').textContent = c.module;
    document.getElementById('modalPayDate').textContent = c.paymentDate;
    document.getElementById('modalAmount').textContent = c.amount;
    document.getElementById('modalRef').textContent = c.reference;
    document.getElementById('modalDesc').textContent = c.description;
    const attachDiv = document.getElementById('modalAttachments');
    attachDiv.innerHTML = '';
    c.attachments.forEach(name=>{
      const box = document.createElement('div');
      box.className = 'me-2 mb-2 p-2 border rounded small-muted';
      box.textContent = name;
      attachDiv.appendChild(box);
    });
    // functionality for modal buttons
    document.getElementById('btnMarkReview').onclick = ()=>updateStatus(c.id,'Under Review',`Marked under review by Treasurer`);
    document.getElementById('btnReject').onclick = ()=>resolveOrReject(c.id,'Rejected');
    document.getElementById('btnResolve').onclick = ()=>resolveOrReject(c.id,'Resolved');
    reviewModal.show();
  }

  // Update status (treasurer action)
  function updateStatus(id,newStatus, actionNote=''){
    const idx = concernsStore.findIndex(x=>x.id===id);
    if(idx===-1) return showToast('Concern not found.');
    const old = concernsStore[idx].status;
    concernsStore[idx].status = newStatus;
    // Append audit
    auditStore.unshift({time:new Date().toISOString(), user:'Treasurer', action: `${newStatus} (was ${old})`, concernId:id, note: actionNote || ''});
    renderTreasurerTable();
    renderStudentHistory();
    renderAudit();
    showToast(`Concern ${id} updated to "${newStatus}".`);
  }

  // Resolve or reject with notes
  function resolveOrReject(id,newStatus){
    const notes = document.getElementById('resolutionNotes').value.trim();
    if(notes === ''){
      if(!confirm('No resolution notes entered. Continue?')) return;
    }
    const idx = concernsStore.findIndex(x=>x.id===id);
    if(idx===-1) return showToast('Concern not found.');
    const old = concernsStore[idx].status;
    concernsStore[idx].status = newStatus;
    // Attach optional supporting filename (demo)
    const resFile = document.getElementById('resolutionFile').files[0];
    if(resFile) concernsStore[idx].attachments.push(resFile.name);
    // Audit entry
    auditStore.unshift({time:new Date().toISOString(), user:'Treasurer', action: `${newStatus} (was ${old})`, concernId:id, note: notes});
    // Simulated notification to student
    showToast(`Concern ${id} marked "${newStatus}". Student will be notified.`);
    reviewModal.hide();
    // clear modal fields
    document.getElementById('resolutionNotes').value = '';
    document.getElementById('resolutionFile').value = '';
    renderTreasurerTable();
    renderStudentHistory();
    renderAudit();
  }

  // Render audit log
  function renderAudit(){
    const container = document.getElementById('auditLog');
    if(!container) return;
    // Use getConcernsAuditLogs if available, otherwise use auditStore
    let logs = [];
    if (typeof getConcernsAuditLogs === 'function') {
      logs = getConcernsAuditLogs();
    } else if (auditStore.length > 0) {
      logs = auditStore.slice(0, 20).map(a => ({
        time: a.time,
        action: a.action,
        user: a.user || 'BU Polangui CSC Treasurer'
      }));
    }
    if(logs.length === 0){ container.innerHTML = '<p class="small-muted">No actions yet.</p>'; return; }
    container.innerHTML = '';
    logs.forEach(a=>{
      const div = document.createElement('div');
      div.className = 'audit-line';
      const timeStr = a.time.includes('T') ? new Date(a.time).toLocaleString() : a.time;
      div.innerHTML = `<div><strong>${escapeHtml(a.action)}</strong></div><div class="small-muted">${timeStr} â€¢ By ${escapeHtml(a.user)}</div>`;
      container.appendChild(div);
    });
  }

  // Utilities
  function showToast(msg){
    document.getElementById('toastBody').textContent = msg;
    toast.show();
  }
  function statusColor(status){
    switch(status){
      case 'Pending Verification': return 'bg-danger text-white';
      case 'Under Review': return 'bg-warning text-dark';
      case 'Resolved': return 'bg-success text-white';
      case 'Rejected': return 'bg-secondary text-white';
      default: return 'bg-light text-dark';
    }
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // small interactions
  document.getElementById('refreshBtn').addEventListener('click', ()=>renderTreasurerTable());
  document.getElementById('filterStatus').addEventListener('change', ()=>renderTreasurerTable());

  // Initial demo seed data from treasurer_data.js
  (function seed(){
    if (typeof treasurerConcerns !== 'undefined' && treasurerConcerns.length > 0) {
      treasurerConcerns.forEach(c => {
        concernsStore.push({
          id: c.id,
          createdAt: c.date + 'T00:00:00',
          studentId: c.studentId,
          studentName: c.studentName,
          module: 'CSC Fee',
          paymentDate: c.date,
          amount: '220.00',
          reference: c.otherDetails.match(/RCPT-[A-Z0-9-]+/)?.[0] || 'N/A',
          description: c.issue,
          attachments: c.proof || [],
          status: c.status
        });
      });
      // Add audit logs from treasurer_data.js
      if (typeof getConcernsAuditLogs === 'function') {
        const auditLogs = getConcernsAuditLogs();
        auditLogs.forEach(log => {
          auditStore.push({
            time: log.time,
            user: log.user,
            action: log.action,
            concernId: log.action.match(/C-\d{4}-\d{3}/)?.[0] || 'N/A'
          });
        });
      }
    }
    renderStudentHistory();
    renderTreasurerTable();
    renderAudit();
  })();

  // Expose for modal onclick from inline handlers
  window.openReview = openReview;

</script>
</body>
</html>
